<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
.mapblock {
    width:100px;
    float:left;
    height:100px;
    text-align:center;
}

#cityblock {
    border:solid 2px;
    height:96px;
    width:96px;
}


</style>
<script type="text/javascript">
//lrn2latin uirifag - significat anglice "hours passed"
var horaepasatae;

//all of these city properties should go into the django model (unless marked otherwise)
var lastUpdate=new Date();
var cityName = "New City";
var owner = "";
var xcoord = 0;
var ycoord = 0;
var population=100000;
var queue = new Array();
var food=110000;
    var foodProduction = 600; //production per worker; normally we would derive this from tech and such
var fuel=100000;
	var fuelProduction = 500; //production per worker; normally we would derive this from tech and such
var mineral=100000;
	var mineralProduction = 500; //production per worker; normally we would derive this from tech and such
var buildings = [0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0]; //each of these values should be a column in the DB; also goes into django model
	var buildingTargets = [0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0]; //for queue purposes - still saved in city DB
	var buildingnames = ["School", "Barracks", "Fortifications", "Municipal Works", "Hospital", "Transportation", "Broadcast Tower", "Workshop", "Foundry", "Airport", "Shipyard","Laboratory","Ethanol Plant","Hydroponics Plant","Recycling Plant","Nuclear Plant","Supercomputer","Space Center"];
	var buildingcosts = [new Array(900,800,700,150),new Array(2000,1700,900,300),new Array(500,1000,200,600),new Array(450,400,300,200),new Array(1600,2000,500,150),new Array(2000,2000,2000,600),new Array(2200,1800,2400,200),new Array(2700,2400,2600,1000),new Array(3000,2400,2600,1000),new Array(5000,10000,12500,3400),new Array(7500,15000,10000,5000)]; //hardcoded
	//still have to add costs to hightechs
	var production = 1000; //normally we'd derive this from population, economy, buildings and tech
	var productionTech = 1; //normally would be sum of all pertinent techs; techs exist in player model/DB
var primarySector = 20000;
var secondarySector = 45000; //will be in the django model, but will grow based on update
var tertiarySector = 1000; //will be in the django model, but will grow based on update


function QueueItem(foodcost,fuelcost,mineralcost,productioncost,task,description,onCancel) {
this.cancel = function() { eval(onCancel);}
this.cost = [foodcost,fuelcost,mineralcost,productioncost];
this.prodleft = this.cost[3];
this.task = task; //raw code executed after completion
this.name = description; //whatever this thing is called
}

function Block(type, improvement, level, target){
this.type=type;
this.improvement=improvement;
this.level=level;
this.target=level; //for queue purposes

return this.type;
}

// it goes NW, N, NE, W, city's own, E, SW, W, SE; derived from block DB
var blocks = [new Block(0,0,5), new Block(0,4,5), new Block(1,1,5), new Block(1,5,5), new Block(2,2,5), new Block(2,6,5), new Block(3,3,5), new Block(4,1,5), new Block(4,5,5)]; //dummy values, normally we'd get from ajax
var blockTypes = ["Plains", "Hills", "Desert", "Water", "Mountain"]; //hardcoded
var blockImprovements = ["Farm", "Mine", "Oil Well", "Fishery", "Quarry", "Coal Mine", "Pasture"];
var blockGraphics = ["http://kingbushido95.ki.funpic.de/ModernDS/graphic/map/gras1.png", "http://kingbushido95.ki.funpic.de/ModernDS/graphic/map/berg2.png", "http://i.imgur.com/CqMI5.png", "http://i.imgur.com/cWv4h.png", "http://i.imgur.com/cE9RQ.png"];

function changeHTML(id, changeTo){
if (changeTo)
	document.getElementById(id).innerHTML = changeTo;
return document.getElementById(id);
}

function upgradeBlock(thingytype) {
var targetNum = document.getElementById("blockchoices").selectedIndex;
var targetBlock = blocks[targetNum];
	targetBlock.target += 1;
var targetTask = "";
var targetName = "";
var cancellation = "blocks[" + targetNum + "].target -= 1;";

var foodcost = 50*Math.pow(1.25,targetBlock.target);
var fuelcost = 60*Math.pow(1.275,targetBlock.target);
var mineralcost = 40*Math.pow(1.245,targetBlock.target);
var productioncost = 50*Math.pow(2,(targetBlock.target));
	
if (thingytype=='simple') {
	targetTask = "blocks[" + targetNum + "].level+=1;";
	targetName = "Upgrade&nbsp;" + blockImprovements[targetBlock.improvement];	
} else {
	var targetType = document.getElementById("typechoices").selectedIndex;

	if ((targetBlock.type == 0) && (targetType != 0 && targetType !=4)) {
		window.alert ("You can only build a Farm or a Quarry on this block!");
		return false;
		}
	if ((targetBlock.type == 1) && (targetType != 1 && targetType !=5)) {
		alert ("You can only build a Mine or a Coal Mine on this block!");
		return false;
		}
	if ((targetBlock.type == 2) && (targetType != 2 && targetType !=6)) {
		alert ("You can only build an Oil Well or a Pasture on this block!");
		return false;
		}
	if ((targetBlock.type == 3) && targetType !=3) {
		alert ("You can only build a Fishery this block!");
		return false;
		}
	if ((targetBlock.type == 4) && (targetType != 1 && targetType != 5)) {
		alert ("You can only build a Mine or a Coal Mine on this block!");
		return false;
		}
	if (targetBlock.improvement == targetType) {
		window.alert ("That block is already a " + blockImprovements[targetBlock.improvement] + ".");
		return false;
		}

	targetTask = "blocks[" + targetNum + "].improvement=" + targetType + "; blocks[" + targetNum + "].level=5;";
	targetName = "Change " + blockImprovements[targetBlock.improvement] + " to " + blockImprovements[targetType];
}
	
queue.push(new QueueItem(foodcost,fuelcost,mineralcost,productioncost,targetTask,targetName,cancellation));
}
	
function upgradeBuilding(targetBuilding,type) {
var targetTask = "";
var targetName = "";
var currentLevel = buildingTargets[targetBuilding];
	buildingTargets[targetBuilding] += (type-1);
var cancellation = "buildingTargets[" + targetBuilding + "]-=" + (type-1) + ";"

if (!currentLevel)
	currentLevel += 1;
	
var foodcost = buildingcosts[targetBuilding][0]*Math.pow(1.25,currentLevel);
var fuelcost = buildingcosts[targetBuilding][1]*Math.pow(1.275,currentLevel);
var mineralcost = buildingcosts[targetBuilding][2]*Math.pow(1.245,currentLevel);
var productioncost = buildingcosts[targetBuilding][3]*Math.pow(1.25,currentLevel);
	
targetTask = "buildings[" + targetBuilding + "] +=" + (type-1) + ";";
	
if (type)
	targetName = "Up";
else
	targetName = "Down";
	
	
targetName += "grade&nbsp;" + buildingnames[targetBuilding];
queue.push(new QueueItem(foodcost,fuelcost,mineralcost,productioncost,targetTask,targetName,cancellation));
}

//lrn2latin uirifag - significat anglice "can build"
function potesseAedifacere(numerus) {
if (buildings[numerus] > 0)
	return true;
//we should probably tweak some of these requirements later
else if (numerus == 4 && (buildings[0] < 1 || buildings[3] < 1))
	return false;
else if (numerus == 6 && ((buildings[0] < 1) || (buildings[5] < 5)))
	return false;
else if (numerus == 7 && (buildings[1] < 5 || buildings[5] < 5))
	return false;
else if (numerus == 8 && (buildings[5] < 5 || buildings[7] < 10))
	return false;
else if (numerus == 9 && (buildings[5] < 20 || buildings[8] < 10))
	return false;
else if (numerus == 10 && (buildings[5] < 20 || buildings[8] < 20))
	return false;
else if (numerus == 11 && (buildings[0] < 10 || buildings[7] < 5))
	return false;
else if (numerus > 11 && (!buildings[11]/*|| science < buildingcosts[numerus][4]*/))
	return false; //all science buildings - will edit when we add the playerwide science system 
else
	return true;
}//fin functionis "potesseAedifacere"; nolite illam futuere!


function update(){
var iam = new Date();
horaepasatae = (iam-lastUpdate)/3600000;

if (queue.length) {
	if (queue[0].cost[0] < food && queue[0].cost[1] < fuel && queue[0].cost[2] < mineral) {
		queue[0].prodleft -= production*horaepasatae;
		changeHTML("queuestatus", "");
		}
	else
		changeHTML("queuestatus", "Requires more resources!");
		if (queue[0].prodleft < 0.01) {
			eval(queue[0].task);
			food -= queue[0].cost[0];
			fuel -= queue[0].cost[1];
			mineral -= queue[0].cost[2];
			queue.shift();
		}
}
	
for (number in blocks) {
		switch (blocks[number].type){
			case 0: {
			food += horaepasatae*((foodProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
			case 1: {
			mineral += horaepasatae*((mineralProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
			case 2: {
			fuel += horaepasatae*((fuelProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
			case 3: {
			food += horaepasatae*((foodProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
			case 4: {
			mineral += 0.5*horaepasatae*((mineralProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
			case 5: {
			fuel += 0.5*horaepasatae*((fuelProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
			case 6: {
			food += 0.5*horaepasatae*((foodProduction)*Math.pow(1.163118,(blocks[number].level - 1));
			break;
			}
		}
	}

if (food < 1)
	food = 1;
if (fuel < 1)
	fuel = 1;
if (mineral < 1)
	mineral = 1;

var health = 0.1+((population-100000)/(1000*Math.pow(1.172103,(buildings[4] - 1)));
population += health*horaepasatae*(Math.log((food+1)/population)*population);

primarySector = 0;
	for (primary in blocks)
	primarySector += 100*Math.pow(1.17,(blocks[primary].level - 1));
secondarySector += horaepasatae*(Math.log((fuel+1)/secondarySector)*secondarySector)*((buildings[3]+(buildings[5]*2)+(buildings[7]*2)+(buildings[8]*3)+(buildings[10]*2))/10);
tertiarySector += horaepasatae*(Math.log((secondarySector+1)/tertiarySector)*tertiarySector)*(((buildings[0]*3)+buildings[3]+(buildings[6]*2)+(buildings[9]*2)+buildings[11])+buildings[16]/10); //we'll make it a bit more complex later
productionTech = ((tertiarySector/secondarySector) + 0.1)*((1+buildings[11])/2);

if ((primarySector+secondarySector) > population)
	secondarySector = population-primarySector;
else if ((primarySector+secondarySector+tertiarySector) > population)
	tertiarySector = population-(primarySector+secondarySector);
	
production = secondarySector*productionTech;

writeStats();
lastUpdate = new Date();
} //end up update function don't f with this {

function writeStats(){
document.title = cityName + " | Gunship Diplomacy";
	
changeHTML("name", cityName);
changeHTML("cityblock", "<h3>" + cityName + "</h3>" + blockTypes[blocks[4].type] + "<br />" + blockImprovements[blocks[4].improvement]);
changeHTML("population", parseInt(population) + " citizens");

changeHTML("primary",parseInt(primarySector));
changeHTML("secondary",parseInt(secondarySector));
changeHTML("tertiary",parseInt(tertiarySector));

changeHTML("food", parseInt(food));
changeHTML("fuel", parseInt(fuel));
changeHTML("mineral", parseInt(mineral));

	if (food > population)
		changeHTML("surplusfood", "Surplus: " + Math.floor(food-population)).style.color = "green";
	else
		changeHTML("surplusfood", "Deficit: " + Math.floor(population-food)).style.color = "red";
	if (food > population)
		changeHTML("surplusfuel", "Surplus: " + Math.floor(fuel-secondarySector)).style.color = "green";
	else
		changeHTML("surplusfuel", "Deficit: " + Math.floor(secondarySector-fuel)).style.color = "red";
	
changeHTML("NW", "<b>" + blockTypes[blocks[0].type] + "</b><br />" + blockImprovements[blocks[0].improvement] + "<br />Level&nbsp;" + blocks[0].level).style.backgroundImage="url(" + blockGraphics[blocks[0].type] + ")";
changeHTML("N", "<b>" + blockTypes[blocks[1].type] + "</b><br />" + blockImprovements[blocks[1].improvement] + "<br />Level&nbsp;" + blocks[1].level).style.backgroundImage="url(" + blockGraphics[blocks[1].type] + ")";
changeHTML("NE",  "<b>" + blockTypes[blocks[2].type] + "</b><br />" + blockImprovements[blocks[2].improvement] + "<br />Level&nbsp;" + blocks[2].level).style.backgroundImage="url(" + blockGraphics[blocks[2].type] + ")";
changeHTML("W",  "<b>" + blockTypes[blocks[3].type] + "</b><br />" + blockImprovements[blocks[3].improvement] + "<br />Level&nbsp;" + blocks[3].level).style.backgroundImage="url(" + blockGraphics[blocks[3].type] + ")";
changeHTML("cityblock", "<b>" + cityName + "</b><br />" + blockTypes[blocks[4].type] + "<br />" + blockImprovements[blocks[4].improvement] + "<br />Level&nbsp;" + blocks[4].level).style.backgroundImage = "url(" + blockGraphics[blocks[4].type] + ")"; // please ensure the similar line in writeStats() matches
changeHTML("E",  "<b>" + blockTypes[blocks[5].type] + "</b><br />" + blockImprovements[blocks[5].improvement] + "<br />Level&nbsp;" + blocks[5].level).style.backgroundImage="url(" + blockGraphics[blocks[5].type] + ")";
changeHTML("SW",  "<b>" + blockTypes[blocks[6].type] + "</b><br />" + blockImprovements[blocks[6].improvement] + "<br />Level&nbsp;" + blocks[6].level).style.backgroundImage="url(" + blockGraphics[blocks[6].type] + ")";
changeHTML("S",  "<b>" + blockTypes[blocks[7].type] + "</b><br />" + blockImprovements[blocks[7].improvement] + "<br />Level&nbsp;" + blocks[7].level).style.backgroundImage="url(" + blockGraphics[blocks[7].type] + ")";
changeHTML("SE", "<b>" + blockTypes[blocks[8].type] + "</b><br />" + blockImprovements[blocks[8].improvement] + "<br />Level&nbsp;" + blocks[8].level).style.backgroundImage="url(" + blockGraphics[blocks[8].type] + ")";

var itemsdiv = document.getElementById("items");
itemsdiv.innerHTML = "<h2>Industry Contracts</h2>";
for (item in queue) {
	queuediv = document.createElement("div");
	queuediv.innerHTML = queue[item].name + "&nbsp;&nbsp;&nbsp;" + Math.round((1-(queue[item].prodleft/queue[item].cost[3]))*100) + "%&nbsp;&nbsp;&nbsp;";
	queuediv.innerHTML += Math.floor((queue[item].prodleft/production)*60) + " minutes " + Math.floor(((queue[item].prodleft/production)*3600)-60*Math.floor((queue[item].prodleft/production)*60)) + " seconds left";
	if (item == 0)
		queuediv.innerHTML += '<button onclick="queue[0].cancel();queue.shift();update();">Cancel</button>';
	itemsdiv.appendChild(queuediv);
}

var buildingsdiv = document.getElementById("buildlevels");
buildingsdiv.innerHTML = "";
for (what in buildings) {
	if (potesseAedifacere(what)){
		var buildingdiv = document.createElement("div");
		buildingdiv.innerHTML = "<b>" + buildingnames[what] + "</b>:&nbsp;Level " + buildings[what];
		buildingdiv.innerHTML += '&nbsp;<button onclick="upgradeBuilding(' + what + ', 2);update();">Upgrade</button>';
		if (buildings[what] != 0)
			buildingdiv.innerHTML += '<button onclick="upgradeBuilding(' + what + ', 0);">Downgrade</button>';
		buildingsdiv.appendChild(buildingdiv);
	}
}

}//end of write function don't f with this }

window.setInterval(update, 1000);
</script>

<title>My City</title>
</head>

<body onload="document.body.style.visibility='hidden';update();document.body.style.visibility='';">
<noscript>Sorry, your browser does not support this game. Turn Javascript on to play.</noscript>

<h1 id="name"></h1>
Change city name: <input type="text" onblur="cityName=this.value;" />

<div style="float:right;padding-right:25%;"><b id="queuestatus" style="color:red;"></b>
<span id="items"></span>
</div>

<p id="population"></p>

<p>Food <span id="food"></span>&nbsp;|&nbsp;Fuel <span id="fuel"></span>&nbsp;|&nbsp;Minerals <span id="mineral"></span>
<br /><span id="surplusfood"></span> | <span id="surplusfuel"></span></p>

<p><b>Resource</b> production employs <b><span id="primary"></span> workers</b><br />
<b>Industrial</b> production employs <b><span id="secondary"></span> workers</b><br />
<b>Business</b> and services employs <b><span id="tertiary"></span> workers</b></p>

<div style="padding-top:10px;visibility:hidden;clear:left"></div>
<div class="mapblock" id="NW"></div>
<div class="mapblock" id="N"></div>
<div class="mapblock" id="NE"></div>
<div style="visibility:hidden;clear:left"></div>
<div class="mapblock" id="W"></div>
<div class="mapblock" id="cityblock"></div>
<div class="mapblock" id="E"></div>
<div style="visibility:hidden;clear:left"></div>
<div class="mapblock" id="SW"></div>
<div class="mapblock" id="S"></div>
<div class="mapblock" id="SE"></div>
<div style="padding-bottom:10px;visibility:hidden;clear:left"></div>

<select id="blockchoices">
	<option value="0">Northwest</option>
	<option value="1">North</option>
	<option value="2">Northeast</option>
	<option value="3">West</option>
	<option value="4">Center</option>
	<option value="5">East</option>
	<option value="6">Southwest</option>
	<option value="7">South</option>
	<option value="8">Southeast</option>
</select> block:
<br />
<button onclick="upgradeBlock('simple');update();">Upgrade</button>
<br /><button onclick="upgradeBlock('change');update()">Change to</button><select id="typechoices">
	<option value="0">Farm</option>
	<option value="1">Mine</option>
	<option value="2">Oil Well</option>
	<option value="3">Fishery</option>
	<option value="4">Quarry</option>
	<option value="5">Coal Mine</option>
	<option value="6">Pasture</option>
</select>

<a name="buildings"><h2>Infrastructure</h2><div id="buildlevels"></div></a>
</body>
</html>
