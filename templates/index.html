<!DOCTYPE html>
<html>
<head>
<style>
.mapblock {
    width:100px;
    float:left;
    height:100px;
    text-align:center;
}

#cityblock {
    border:solid 2px;
    height:96px;
    width:96px;
}


</style>
<script type="text/javascript">
var lastUpdate=new Date();
var horaepasatae;

//all of these city properties should go into the django model
var cityName = "New City";
var player = "King Medi";
var population=100000;
var queue = new Array();

function QueueItem(foodcost,fuelcost,mineralcost,productioncost,task,description) {
    this.cost = [foodcost,fuelcost,mineralcost,productioncost];
    this.prodleft = this.cost[3];
    this.task = task; //raw code executed after completion
    this.name = description; //whatever this thing is called
}



function Block(type, improvement, level){
this.type=type;
this.improvement=improvement;
this.level=level;

return this.type;
}

// it goes NW, N, NE, W, city's own, E, SW, W, SE
var blocks = [new Block(0,0,5), new Block(0,4,5), new Block(1,1,5), new Block(1,5,5), new Block(2,2,5), new Block(2,6,5), new Block(3,3,5), new Block(4,2,5), new Block(4,5,5)]; //dummy values, normally we'd get from ajax
var blockTypes = ["Plains", "Hills", "Desert", "Water", "Mountain"];
var blockImprovements = ["Farm", "Mine", "Oil Well", "Fishery", "Quarry", "Coal Mine", "Pasture"];
var blockGraphics = ["http://kingbushido95.ki.funpic.de/ModernDS/graphic/map/gras1.png", "http://kingbushido95.ki.funpic.de/ModernDS/graphic/map/berg2.png", "http://i.imgur.com/CqMI5.png", "http://i.imgur.com/cWv4h.png", "http://i.imgur.com/cE9RQ.png"];

//all dummy values to be filled in with ajax
var food=200000;
    var foodProduction = 30;
	//production per workier; normally we would derive this from tech and such
var fuel=100000;
	var fuelProduction = 25;
var mineral=100000;
	var mineralProduction = 25;
	
var production = 1000;
	//normally we'd derive this from population, economy, buildings and tech

function changeHTML(id, changeTo){
document.getElementById(id).innerHTML = changeTo;
return document.getElementById(id);
}

function update(){
    var iam = new Date();
    horaepasatae = (iam-lastUpdate)/21600000;

	
	for (number in blocks) {
		switch (blocks[number].type){
			case 0: {
			food += horaepasatae*((foodProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
			case 1: {
			mineral += horaepasatae*((mineralProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
			case 2: {
			fuel += horaepasatae*((fuelProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
			case 3: {
			food += 0.75*horaepasatae*((foodProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
			case 4: {
			mineral += horaepasatae*((mineralProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
			case 5: {
			fuel += 0.75*horaepasatae*((fuelProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
			case 6: {
			food += horaepasatae*((foodProduction)*1.163118^(blocks[number].level - 1));
			break;
			}
		}
	}

	
    population += (Math.log((food+1)/population)*population)*horaepasatae;
    if (queue.length) {
	queue[0].prodleft -= production*horaepasatae;
		if (queue[0].prodleft < 0.01) {
			eval(queue[0].task);
			food -= queue[0].cost[0];
			fuel -= queue[0].cost[1];
			mineral -= queue[0].cost[2];
			queue.shift();
		}
}

writeStats();
lastUpdate = new Date();
}

function writeStats(){
    document.title = cityName + " | Gunship Diplomacy";
    
	changeHTML("name", cityName);
    changeHTML("cityblock", "<h3>" + cityName + "</h3>" + blockTypes[blocks[4].type] + "<br />" + blockImprovements[blocks[4].improvement]);
    changeHTML("population", parseInt(population) + " working population");
    
    changeHTML("food", parseInt(food));
    changeHTML("fuel", parseInt(fuel));
    changeHTML("mineral", parseInt(mineral));

    var itemsdiv = document.getElementById("items");
    itemsdiv.innerHTML = "";
    for (item in queue) {
		queuediv = document.createElement("div");
		queuediv.innerHTML = queue[item].name + "&nbsp;&nbsp;&nbsp;" + Math.round((1-(queue[item].prodleft/queue[item].cost[3]))*100) + "%";
		if (item == 0)
			queuediv.innerHTML += '<button onclick="queue.shift();update();">Cancel</button>';
		itemsdiv.appendChild(queuediv);
    }
	
	//next part is only temporary, we'll add it to the divsoup later
	var blockImprovementLevelTextInnerHTMLTarget = "<b>Improvement levels:</b><br />"; //because fuck you, that's why
	for (numbr in blocks) {
		blockImprovementLevelTextInnerHTMLTarget += "<b>" + blockImprovements[blocks[numbr].improvement];
		blockImprovementLevelTextInnerHTMLTarget += "</b>&nbsp;level&nbsp;";
		blockImprovementLevelTextInnerHTMLTarget += blocks[numbr].level;
		blockImprovementLevelTextInnerHTMLTarget += ",&nbsp;";
	}
	changeHTML("blocklevels",blockImprovementLevelTextInnerHTMLTarget);
	//unt dis is fur die testen
	var blockYieldLevelTextInnerHTMLTarget = "<b>Improvement yields:</b><br />"; //because fuck you, that's why
	for (numbr in blocks) {
		blockYieldLevelTextInnerHTMLTarget += "<b>" + blockImprovements[blocks[numbr].improvement] + "</b>&nbsp;";
		switch (blocks[numbr].improvement){
			case 0: {
			blockYieldLevelTextInnerHTMLTarget += ((foodProduction)*1.163118^(blocks[numbr].level - 1)) + " food";
			break;
			}
			case 1: {
			blockYieldLevelTextInnerHTMLTarget += ((mineralProduction)*1.163118^(blocks[numbr].level - 1)) + " mineral";
			break;
			}
			case 2: {
			blockYieldLevelTextInnerHTMLTarget +=  ((fuelProduction)*1.163118^(blocks[numbr].level - 1)) + " fuel";
			break;
			}
			case 3: {
			blockYieldLevelTextInnerHTMLTarget += 0.75*((foodProduction)*1.163118^(blocks[numbr].level - 1)) + " food";
			break;
			}
			case 4: {
			blockYieldLevelTextInnerHTMLTarget += ((mineralProduction)*1.163118^(blocks[numbr].level - 1)) + " mineral";
			break;
			}
			case 5: {
			blockYieldLevelTextInnerHTMLTarget += 0.75*((fuelProduction)*1.163118^(blocks[numbr].level - 1)) + " fuel";
			break;
			}
			case 6: {
			blockYieldLevelTextInnerHTMLTarget += ((foodProduction)*1.163118^(blocks[numbr].level - 1)) + " food";
			break;
			}
		}
		blockYieldLevelTextInnerHTMLTarget += " per hour,&nbsp;";
	}
	changeHTML("blockyields",blockYieldLevelTextInnerHTMLTarget);
}

function loaded() {
update();
changeHTML("NW", "<h4>" + blockTypes[blocks[0].type] + "</h4>" + blockImprovements[blocks[0].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[0].type] + ")";
changeHTML("N", "<h4>" + blockTypes[blocks[1].type] + "</h4>" + blockImprovements[blocks[1].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[1].type] + ")";
changeHTML("NE", "<h4>" + blockTypes[blocks[2].type] + "</h4>" + blockImprovements[blocks[2].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[2].type] + ")";
changeHTML("W", "<h4>" + blockTypes[blocks[3].type] + "</h4>" + blockImprovements[blocks[3].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[3].type] + ")";
changeHTML("cityblock", "<h3>" + cityName + "</h3>" + blockTypes[blocks[4].type] + "<br />" + blockImprovements[blocks[4].improvement]).style.backgroundImage = "url(" + blockGraphics[blocks[4].type] + ")"; // please ensure the similar line in writeStats() matches
changeHTML("E", "<h4>" + blockTypes[blocks[5].type] + "</h4>" + blockImprovements[blocks[5].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[5].type] + ")";
changeHTML("SW", "<h4>" + blockTypes[blocks[6].type] + "</h4>" + blockImprovements[blocks[6].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[6].type] + ")";
changeHTML("S", "<h4>" + blockTypes[blocks[7].type] + "</h4>" + blockImprovements[blocks[7].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[7].type] + ")";
changeHTML("SE", "<h4>" + blockTypes[blocks[8].type] + "</h4>" + blockImprovements[blocks[8].improvement]).style.backgroundImage="url(" + blockGraphics[blocks[8].type] + ")";
}

function upgradeBlock(thingytype) {

	if (thingytype == "simple") {
	var targetNum = document.getElementById("blockchoices").selectedIndex;
	var targetblock = blocks[targetNum];
	var targettask = "blocks[" + targetNum + "].level+=1;";
	
	var foodcost = 50*1.25^(targetblock.level - 1);
	var fuelcost = 60*1.275^(targetblock.level - 1);
	var mineralcost = 40*1.245^(targetblock.level - 1);
	var productioncost = Math.log(targetblock.level);
	
	queue.push(new QueueItem(foodcost,fuelcost,mineralcost,productioncost,targettask,"Upgrade&nbsp;" + blockImprovements[targetblock.improvement]));

	} else {
	//changing block types
	}
	
}
	
window.setInterval(update, 1000);
</script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>My City</title>
</head>

<body onload="loaded();">

<h1 id="name"></h1>
Change city name: <input type="text" onblur="cityName=this.value;" />
<div id="test"></div>
<p id="population"></p>

Food <span id="food"></span>&nbsp;|&nbsp;Fuel <span id="fuel"></span>&nbsp;|&nbsp;Minerals <span id="mineral"></span>

<div style="padding-top:10px;visibility:hidden;clear:left"></div>
<div class="mapblock" id="NW"></div>
<div class="mapblock" id="N"></div>
<div class="mapblock" id="NE"></div>
<div style="visibility:hidden;clear:left"></div>
<div class="mapblock" id="W"></div>
<div class="mapblock" id="cityblock"></div>
<div class="mapblock" id="E"></div>
<div style="visibility:hidden;clear:left"></div>
<div class="mapblock" id="SW"></div>
<div class="mapblock" id="S"></div>
<div class="mapblock" id="SE"></div>
<div style="padding-bottom:10px;visibility:hidden;clear:left"></div>


<button onclick="upgradeBlock('simple');">Upgrade</button><select id="blockchoices">
	<option value="0">Northwest</option>
	<option value="1">North</option>
	<option value="2">Northeast</option>
	<option value="3">West</option>
	<option value="4">Center</option>
	<option value="5">East</option>
	<option value="6">Southwest</option>
	<option value="7">South</option>
	<option value="8">Southeast</option>
</select> block

<p id="blocklevels"></p>
<p id="blockyields"></p>

<h3>Task Queue</h3>
<div id="items"></div>
</body>
</html>